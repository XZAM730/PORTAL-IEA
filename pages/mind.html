<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a0f">
    <title>IEA - Jurnal Konstelasi</title>
    
    <!-- Unified Theme CSS -->
    <link rel="stylesheet" href="../css/theme.css">
    <link rel="stylesheet" href="../css/compatibility.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.2.4/dist/mermaid.min.js"></script>

    <style>
        /* --- 1. COSMIC THEME SYSTEM --- */
        :root {
            --bg-deep: #000000;
            --bg-surface: #0a0a0a;
            --bg-glass: rgba(10, 10, 10, 0.85);
            --border: #1f1f1f;
            --primary: #3498db;
            --primary-dim: rgba(52, 152, 219, 0.1);
            --accent: #f1c40f;
            --danger: #e74c3c;
            --text-main: #eeeeee;
            --text-muted: #888888;
            --safe-area-bottom: env(safe-area-inset-bottom);
            
            /* RANK COLORS */
            --rank-novice: #bdc3c7; 
            --rank-junior: #3498db;
            --rank-senior: #9b59b6;
            --rank-prof: #f1c40f;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* --- 2. HEADER (Fixed Top) --- */
        header {
            height: 55px;
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
            position: absolute; top: 0; width: 100%; z-index: 100;
        }
        .logo { font-weight: 900; letter-spacing: -0.5px; font-size: 1.1rem; }
        .logo span { color: var(--primary); }
        .header-act i { font-size: 1.1rem; color: var(--text-muted); margin-left: 18px; cursor: pointer; transition: 0.2s; }
        .header-act i:hover { color: #fff; }

        /* SEARCH BAR (Overlay) */
        #searchBox {
            position: absolute; top: 0; left: 0; width: 100%; height: 55px;
            background: var(--bg-surface); z-index: 101; display: none; align-items: center; padding: 0 10px;
            border-bottom: 1px solid var(--primary);
        }
        #searchInput {
            flex: 1; background: transparent; border: none; color: #fff; font-size: 1rem; margin-left: 10px; font-family: 'Inter', sans-serif;
        }

        /* --- 3. FEED (Scrollable) --- */
        #mainFeed {
            flex: 1; overflow-y: auto;
            padding: 70px 12px 160px 12px; /* Bottom padding besar untuk input area */
            scroll-behavior: smooth;
        }

        /* CARD DESIGN */
        .card {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 16px; margin-bottom: 16px;
            position: relative; transition: background 0.2s;
        }
        .card:active { background: #111; }

        /* USER HEADER */
        .card-head { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .avatar { 
            width: 42px; height: 42px; border-radius: 12px; background: #151515; 
            display: flex; align-items: center; justify-content: center; 
            color: var(--primary); border: 1px solid var(--border); cursor: pointer;
            font-size: 1.1rem;
        }
        .u-meta h4 { font-size: 0.95rem; font-weight: 700; margin-bottom: 2px; }
        .u-meta span { font-size: 0.75rem; color: var(--text-muted); display: block; }

        /* RANK GLOW */
        .r-novice { color: var(--rank-novice); }
        .r-senior { color: var(--rank-senior); text-shadow: 0 0 8px rgba(155, 89, 182, 0.3); }
        .r-prof { color: var(--rank-prof); text-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }

        /* CONTENT */
        .ctx-reason {
            font-size: 0.8rem; color: #bbb; border-left: 3px solid var(--primary);
            padding-left: 10px; margin-bottom: 12px; font-style: italic; background: var(--primary-dim);
            padding-top: 4px; padding-bottom: 4px; border-radius: 0 4px 4px 0;
        }
        .ctx-body { font-size: 0.95rem; line-height: 1.6; color: #e5e5e5; white-space: pre-wrap; word-break: break-word; }
        
        /* ATTACHMENTS */
        .media-img { width: 100%; border-radius: 8px; margin-top: 12px; border: 1px solid var(--border); max-height: 350px; object-fit: cover; }
        .mermaid { margin-top: 12px; background: #050505; padding: 10px; border-radius: 8px; overflow-x: auto; border: 1px solid var(--border); }
        .latex-block { overflow-x: auto; padding: 5px 0; }

        /* ACTIONS */
        .card-stat { display: flex; gap: 15px; margin-top: 12px; padding-bottom: 8px; border-bottom: 1px solid #1a1a1a; font-size: 0.75rem; color: #555; }
        .card-act { display: flex; justify-content: space-between; margin-top: 8px; }
        .btn-act {
            background: transparent; border: none; color: #777; font-size: 0.9rem; 
            display: flex; align-items: center; gap: 6px; padding: 8px 0; cursor: pointer;
        }
        .btn-act:hover { color: #fff; }
        .liked { color: var(--danger) !important; animation: pulse 0.3s; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.2);} 100% {transform: scale(1);} }

        /* DEBATE / COMMENTS */
        .debate-box { display: none; background: #000; margin-top: 10px; border-radius: 8px; padding: 10px; border-left: 2px solid #222; }
        .cmt-item { margin-bottom: 12px; border-bottom: 1px solid #1a1a1a; padding-bottom: 8px; }
        .cmt-item:last-child { border: none; margin-bottom: 0; }
        .cmt-user { font-size: 0.8rem; font-weight: 700; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .cmt-text { font-size: 0.9rem; color: #ccc; }

        /* --- 4. BOTTOM DOCK (Sticky Input) --- */
        .bottom-dock {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(10,10,10,0.98); backdrop-filter: blur(15px);
            border-top: 1px solid var(--border); z-index: 500;
            padding-bottom: var(--safe-area-bottom);
        }

        /* REPLY CONTEXT BANNER */
        .reply-ctx {
            background: #111; padding: 8px 15px; font-size: 0.8rem; color: var(--primary);
            display: none; align-items: center; justify-content: space-between; border-bottom: 1px solid #222;
        }

        /* EXPANDABLE TOOLS */
        .tools-area {
            display: none; gap: 8px; padding: 10px 15px; overflow-x: auto; background: #080808;
        }
        .tools-area.show { display: flex; }
        .mini-inp { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 6px; min-width: 120px; font-size: 0.8rem; }

        /* INPUT ROW */
        .input-row { display: flex; gap: 10px; align-items: flex-end; padding: 10px 15px; }
        .btn-plus {
            width: 40px; height: 40px; border-radius: 50%; background: #1a1a1a; color: #888;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; border: 1px solid #333;
        }
        .main-inp {
            flex: 1; background: #050505; border: 1px solid #333; color: #fff;
            padding: 10px 15px; border-radius: 20px; font-family: inherit; font-size: 0.95rem;
            resize: none; height: 42px; max-height: 100px; transition: 0.2s;
        }
        .main-inp:focus { border-color: var(--primary); height: 70px; }
        .btn-send {
            width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: #fff;
            border: none; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.2);
        }

        /* NAVIGATION TABS */
        .nav-bar { display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #1a1a1a; }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; gap: 4px; color: #555; 
            width: 60px; cursor: pointer; transition: 0.2s; position: relative;
        }
        .nav-btn i { font-size: 1.3rem; }
        .nav-btn span { font-size: 0.6rem; font-weight: 700; letter-spacing: 0.5px; }
        .nav-btn.active { color: var(--primary); transform: translateY(-2px); }
        .notif-dot { position: absolute; top: -2px; right: 12px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; display: none; border: 1px solid #000; }

        /* --- 5. MODALS & UTILS --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: #111; border: 1px solid #333; width: 90%; max-width: 380px; padding: 25px; border-radius: 16px; max-height: 90vh; overflow-y: auto; }
        
        .full-btn { width: 100%; padding: 14px; background: var(--primary); border: none; font-weight: 700; border-radius: 8px; color: #fff; margin-top: 15px; cursor: pointer; }
        .field { width: 100%; padding: 14px; background: #050505; border: 1px solid #333; color: #fff; margin-bottom: 10px; border-radius: 8px; }
        
        #toast { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: #111; border: 1px solid var(--primary); color: #fff; padding: 10px 20px; border-radius: 20px; z-index: 3000; display: none; font-size: 0.85rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* TRENDING SPECIFIC */
        .trend-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #0e0e0e; border-radius: 8px; margin-bottom: 8px; border: 1px solid #1a1a1a; cursor: pointer; }
        .trend-idx { font-size: 1.2rem; font-weight: 900; color: #333; width: 30px; text-align: center; }
        
        /* EDIT PROFILE TAGS */
        .skill-tag { background: var(--primary-dim); color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; border: 1px solid var(--primary); margin-right: 4px; margin-bottom: 4px; display: inline-block; }
    </style>
</head>
<body>

    <div id="toast">Notifikasi System</div>

    <div id="authModal" class="modal" style="display: flex;">
        <div class="modal-box">
            <h2 style="text-align:center; color:#fff; margin-bottom:5px;">IEA <span style="color:var(--primary)">ACCESS</span></h2>
            <p style="text-align:center; color:#666; font-size:0.8rem; margin-bottom:20px;">Cosmic Mind Network</p>
            
            <div id="formLogin">
                <input id="lUser" class="field" placeholder="Username / ID">
                <input id="lPass" type="password" class="field" placeholder="Password">
                <button class="full-btn" onclick="auth('login')">MASUK</button>
                <p style="text-align:center; margin-top:15px; font-size:0.8rem; color:#888; cursor:pointer;" onclick="toggleAuth(true)">Belum punya akun? Daftar</p>
            </div>

            <div id="formReg" style="display:none;">
                <input id="rUser" class="field" placeholder="Buat Username Unik">
                <input id="rPass" type="password" class="field" placeholder="Password">
                <input id="rSoc" class="field" placeholder="Link Sosmed (Untuk Verifikasi)">
                <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:5px;">Keahlian Utama:</label>
                <select id="rSkill" class="field">
                    <option>General Science</option><option>Astrofisika</option><option>Fisika Kuantum</option>
                    <option>Biologi</option><option>Teknologi</option><option>Filsafat</option>
                </select>
                <button class="full-btn" onclick="auth('register')">DAFTAR IDENTITAS</button>
                <p style="text-align:center; margin-top:15px; font-size:0.8rem; color:#888; cursor:pointer;" onclick="toggleAuth(false)">Kembali Login</p>
            </div>
        </div>
    </div>

    <div id="profModal" class="modal">
        <div class="modal-box">
            <div style="text-align:right;"><i class="fas fa-times" onclick="closeModal()" style="color:#666; cursor:pointer;"></i></div>
            
            <div id="viewMode">
                <div style="text-align:center;">
                    <div style="width:70px; height:70px; background:#1a1a1a; border-radius:20px; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; color:var(--primary); font-size:2rem; border:1px solid #333;">
                        <i class="fas fa-user-astronaut"></i>
                    </div>
                    <h3 id="pName" style="color:#fff; margin-bottom:5px;">User</h3>
                    <div id="pRank" style="font-size:0.8rem; font-weight:bold; letter-spacing:1px; text-transform:uppercase;">RANK</div>
                </div>
                
                <p id="pBio" style="text-align:center; color:#aaa; font-style:italic; margin:15px 0; font-size:0.9rem;">...</p>
                <div id="pTags" style="text-align:center; margin-bottom:20px;"></div>
                
                <div style="display:flex; justify-content:space-around; background:#080808; padding:15px; border-radius:10px; border:1px solid #222;">
                    <div style="text-align:center;"><strong id="vXP" style="color:#fff;">0</strong><br><span style="font-size:0.6rem; color:#666;">XP</span></div>
                    <div style="text-align:center;"><strong id="vLvl" style="color:#fff;">1</strong><br><span style="font-size:0.6rem; color:#666;">LVL</span></div>
                    <div style="text-align:center;"><strong id="vCit" style="color:#fff;">0</strong><br><span style="font-size:0.6rem; color:#666;">KUTIPAN</span></div>
                </div>

                <button id="btnEdit" class="full-btn" style="background:#222; border:1px solid #444;" onclick="openEdit()">EDIT PROFIL</button>
                <button id="btnLogout" class="full-btn" style="background:transparent; border:1px solid var(--danger); color:var(--danger); margin-top:10px;" onclick="logout()">LOGOUT</button>
            </div>

            <div id="editMode" style="display:none;">
                <h4 style="color:#fff; text-align:center; margin-bottom:15px;">Edit Persona</h4>
                <input id="eName" class="field" placeholder="Nama Tampilan">
                <textarea id="eBio" class="field" placeholder="Bio Singkat" style="height:80px;"></textarea>
                
                <label style="font-size:0.8rem; color:#888;">Tambah Skill:</label>
                <select id="eSkillSel" class="field" onchange="addSkillTag(this.value)">
                    <option value="">-- Pilih --</option>
                    <option>Astrofisika</option><option>Kosmologi</option><option>Fisika Partikel</option>
                    <option>Kimia</option><option>Biologi</option><option>Coding</option>
                    <option>Psikologi</option><option>Sejarah</option><option>Seni</option>
                </select>
                <div id="editTags" style="margin-bottom:15px;"></div>
                
                <button class="full-btn" onclick="saveProfile()">SIMPAN</button>
                <button class="full-btn" style="background:#222;" onclick="closeEdit()">BATAL</button>
            </div>
        </div>
    </div>

    <header>
        <div class="logo">IEA <span>NETWORK</span></div>
        <div class="header-act">
            <i class="fas fa-search" onclick="toggleSearch()"></i>
            <i class="fas fa-sync-alt" onclick="loadData()"></i>
        </div>
        <div id="searchBox">
            <i class="fas fa-arrow-left" style="color:#fff;" onclick="toggleSearch()"></i>
            <input id="searchInput" placeholder="Cari Peneliti / Topik..." onkeyup="doSearch()">
        </div>
    </header>

    <div id="mainFeed"></div>

    <div class="bottom-dock">
        <div id="replyCtx" class="reply-ctx">
            <div><i class="fas fa-reply"></i> Membalas: <b id="rTarget">User</b></div>
            <div onclick="cancelReply()"><i class="fas fa-times"></i></div>
        </div>

        <div id="toolsArea" class="tools-area">
            <input id="iReason" class="mini-inp" placeholder="Latar Belakang Observasi..." style="flex:2;">
            <select id="iCat" class="mini-inp">
                <option>Umum</option><option>Astrofisika</option><option>Fisika</option><option>Biologi</option><option>Teknologi</option>
            </select>
            <input id="iImg" class="mini-inp" placeholder="Link Gambar...">
            <input id="iRef" class="mini-inp" placeholder="Link Referensi...">
        </div>

        <div class="input-row">
            <div class="btn-plus" onclick="toggleTools()"><i class="fas fa-plus"></i></div>
            <textarea id="iText" class="main-inp" placeholder="Tulis Hipotesis..."></textarea>
            <button id="btnSend" class="btn-send" onclick="sendPost()"><i class="fas fa-paper-plane"></i></button>
        </div>

        <div class="nav-bar">
            <div class="nav-btn active" onclick="nav('feed', this)"><i class="fas fa-home"></i><span>HOME</span></div>
            <div class="nav-btn" onclick="nav('trend', this)"><i class="fas fa-fire"></i><span>TREND</span></div>
            <div class="nav-btn" onclick="nav('notif', this)">
                <div style="position:relative;"><i class="fas fa-bell"></i><div id="dot" class="notif-dot"></div></div><span>NOTIF</span>
            </div>
            <div class="nav-btn" onclick="myProf()"><i class="fas fa-user-circle"></i><span>AKUN</span></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // URL Apps Script kamu (V.Social)
        const API_URL = "https://script.google.com/macros/s/AKfycbwG1lONsQWWczmbXCq541amnzhGdTKDOquDKTNeMenenZVT3sGUZ_0ubp-gm090JZOH-A/exec";

        // State Management
        let user = localStorage.getItem('ieaUser');
        let db = { posts: [], profiles: [], notifs: [], likes: [] };
        let tab = 'feed';
        let replyID = null;
        let searchQ = "";
        let tempSkills = [];

        // --- INIT ---
        window.onload = () => {
            mermaid.initialize({ startOnLoad: false, theme: 'dark' });
            if(user) {
                document.getElementById('authModal').style.display = 'none';
                loadData();
            }
        };

        // --- CORE DATA LOGIC ---
        async function loadData() {
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                
                // Mapping Array ke Object supaya mudah dibaca
                db.posts = json.posts.map(r => ({ date:r[0], user:r[1], text:r[2], img:r[3], ref:r[4], parent:r[5], uid:r[6], cat:r[7], reason:r[8], format:r[9], verify:r[10] })).reverse();
                db.profiles = json.profiles.map(r => ({ user:r[0], name:r[1], bio:r[2], skills:r[3], xp:r[5], lvl:r[6], rank:r[7], cit:r[9] }));
                db.likes = json.interactions.filter(x => x[3] === 'LIKE');
                db.notifs = json.notifications.filter(x => x[1] === user).reverse();

                render();
                checkNotif();
            } catch(e) { showToast("Gagal sync data."); }
        }

        // --- RENDER SYSTEM ---
        function render() {
            const el = document.getElementById('mainFeed');
            el.innerHTML = "";

            // 1. FEED TAB
            if(tab === 'feed') {
                let data = db.posts.filter(p => !p.parent); // Hanya post induk
                
                // Filter Pencarian
                if(searchQ) {
                    data = data.filter(p => 
                        p.text.toLowerCase().includes(searchQ) || 
                        p.user.toLowerCase().includes(searchQ) ||
                        p.cat.toLowerCase().includes(searchQ)
                    );
                }

                if(data.length === 0) el.innerHTML = `<div style="text-align:center; padding-top:50px; color:#555;">Belum ada jurnal ilmiah.<br>Mulailah menulis.</div>`;
                data.forEach(p => el.appendChild(createCard(p)));
                mermaid.run();
            } 
            // 2. TRENDING TAB (Algoritma Keren)
            else if(tab === 'trend') {
                // Skor = Likes + (Replies * 2)
                const scored = db.posts.filter(p => !p.parent).map(p => {
                    const l = db.likes.filter(x => x[2] === p.uid).length;
                    const c = db.posts.filter(x => x.parent === p.uid).length;
                    return { ...p, score: l + (c*2), l, c };
                }).sort((a,b) => b.score - a.score).slice(0, 10);

                el.innerHTML = `<h3 style="margin-bottom:15px; padding-left:5px;">Topik Hangat ðŸ”¥</h3>`;
                scored.forEach((p, idx) => {
                    const div = document.createElement('div'); div.className = 'trend-row';
                    div.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px; overflow:hidden;">
                            <div class="trend-idx">${idx+1}</div>
                            <div>
                                <div style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;">${p.text.substring(0,50)}...</div>
                                <div style="font-size:0.75rem; color:#666;">${p.l} Likes â€¢ ${p.c} Argumen</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color:#333;"></i>
                    `;
                    div.onclick = () => { searchQ = p.text.substring(0,15); document.getElementById('searchInput').value=searchQ; toggleSearch(true); nav('feed'); };
                    el.appendChild(div);
                });
            }
            // 3. NOTIFICATION TAB
            else if(tab === 'notif') {
                if(db.notifs.length === 0) el.innerHTML = `<div style="text-align:center; padding-top:50px; color:#555;">Tidak ada notifikasi.</div>`;
                db.notifs.forEach(n => {
                    const div = document.createElement('div'); div.className = 'card';
                    div.innerHTML = `
                        <div style="font-size:0.9rem; margin-bottom:5px;">
                            <strong style="color:var(--primary);">${n[2]}</strong> ${n[3]}
                        </div>
                        <div style="font-size:0.7rem; color:#666;">${timeAgo(n[0])}</div>
                    `;
                    el.appendChild(div);
                });
            }
        }

        // --- COMPONENT: CARD ---
        function createCard(p) {
            const prof = db.profiles.find(x => x.user === p.user) || { name: p.user, rank: 'Novice' };
            const likes = db.likes.filter(x => x[2] === p.uid).length;
            const comments = db.posts.filter(x => x.parent === p.uid);
            const isLiked = db.likes.some(x => x[1] === user && x[2] === p.uid);
            
            // Rank Color Logic
            let rClass = "r-novice";
            if(prof.rank.includes("Senior")) rClass = "r-senior";
            if(prof.rank.includes("Prof")) rClass = "r-prof";

            // Content Formatting
            let html = p.text.replace(/\n/g, "<br>");
            if(p.format === 'latex') try { html = katex.renderToString(p.text, {throwOnError:false}); } catch(e){}
            else if(p.format === 'diagram') html = `<div class="mermaid">${p.text}</div>`;

            const div = document.createElement('div'); div.className = 'card';
            div.innerHTML = `
                <div class="card-head">
                    <div class="avatar" onclick="viewUser('${p.user}')"><i class="fas fa-user-astronaut"></i></div>
                    <div class="u-meta">
                        <h4 class="${rClass}">${prof.name}</h4>
                        <span>${prof.rank} â€¢ ${timeAgo(p.date)}</span>
                    </div>
                </div>
                ${p.reason ? `<div class="ctx-reason">"${p.reason}"</div>` : ''}
                <div class="ctx-body ${p.format==='latex'?'latex-block':''}">${html}</div>
                ${p.img ? `<img src="${p.img}" class="media-img" loading="lazy">` : ''}
                
                <div class="card-stat">
                    <span>${likes} Apresiasi</span>
                    <span>${comments.length} Argumen</span>
                </div>
                <div class="card-act">
                    <button class="btn-act ${isLiked?'liked':''}" onclick="doLike('${p.uid}')"><i class="${isLiked?'fas':'far'} fa-heart"></i> Like</button>
                    <button class="btn-act" onclick="toggleDebate('${p.uid}')"><i class="far fa-comments"></i> Debat</button>
                    <button class="btn-act" onclick="prepReply('${p.uid}', '${prof.name}')"><i class="fas fa-reply"></i> Bantah</button>
                </div>

                <div id="debate-${p.uid}" class="debate-box">
                    ${comments.length ? comments.map(c => renderComment(c)).join('') : '<div style="font-size:0.8rem; color:#555;">Belum ada argumen.</div>'}
                </div>
            `;
            return div;
        }

        function renderComment(c) {
            const prof = db.profiles.find(x => x.user === c.user) || { name: c.user };
            return `
                <div class="cmt-item">
                    <div class="cmt-user">
                        <span style="color:var(--primary);">${prof.name}</span>
                        <span style="color:#444; font-size:0.7rem;">${timeAgo(c.date)}</span>
                    </div>
                    <div class="cmt-text">${c.text}</div>
                </div>
            `;
        }

        // --- INTERACTION LOGIC ---
        function toggleDebate(uid) {
            const el = document.getElementById(`debate-${uid}`);
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        async function doLike(uid) {
            showToast("Disukai!");
            await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"interact", user:user, uid:uid, type:"LIKE"})});
            loadData(); // Sync background
        }

        function prepReply(uid, name) {
            replyID = uid;
            document.getElementById('rTarget').innerText = name;
            document.getElementById('replyCtx').style.display = 'flex';
            document.getElementById('iText').focus();
        }

        function cancelReply() {
            replyID = null;
            document.getElementById('replyCtx').style.display = 'none';
        }

        async function sendPost() {
            const txt = document.getElementById('iText').value;
            if(!txt.trim()) return showToast("Tulis sesuatu dulu!");
            
            const btn = document.getElementById('btnSend');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            
            await fetch(API_URL, {method:"POST", body:JSON.stringify({
                action: "post",
                user: user,
                text: txt,
                reason: document.getElementById('iReason').value || (replyID ? "Balasan Argumen" : "Hipotesis Baru"),
                cat: document.getElementById('iCat').value,
                img: document.getElementById('iImg').value,
                ref: document.getElementById('iRef').value,
                parent: replyID || ""
            })});

            document.getElementById('iText').value = "";
            document.getElementById('iReason').value = "";
            document.getElementById('toolsArea').classList.remove('show');
            btn.innerHTML = `<i class="fas fa-paper-plane"></i>`;
            cancelReply();
            showToast("Terpublikasi!");
            loadData();
        }

        // --- PROFILE SYSTEM (VIEW & EDIT) ---
        function viewUser(uid) {
            const p = db.profiles.find(x => x.user === uid);
            if(!p) return;

            // Isi Data View
            document.getElementById('pName').innerText = p.name;
            let rClass = "r-novice"; if(p.rank.includes("Senior")) rClass="r-senior"; if(p.rank.includes("Prof")) rClass="r-prof";
            document.getElementById('pName').className = rClass;
            document.getElementById('pRank').innerText = p.rank;
            document.getElementById('pRank').className = rClass;
            document.getElementById('pBio').innerText = p.bio || "Tidak ada bio.";
            
            // Skills Tag
            const tags = document.getElementById('pTags'); tags.innerHTML = "";
            if(p.skills) p.skills.split(',').forEach(s => tags.innerHTML += `<span class="skill-tag">${s}</span>`);

            // Stats
            document.getElementById('vXP').innerText = p.xp;
            document.getElementById('vLvl').innerText = p.lvl;
            document.getElementById('vCit').innerText = p.cit || 0;

            // Tombol Owner
            const isMe = (uid === user);
            document.getElementById('btnEdit').style.display = isMe ? 'block' : 'none';
            document.getElementById('btnLogout').style.display = isMe ? 'block' : 'none';
            
            closeEdit(); // Pastikan mode edit tertutup
            document.getElementById('profModal').style.display = 'flex';
        }

        function openEdit() {
            const p = db.profiles.find(x => x.user === user);
            document.getElementById('viewMode').style.display = 'none';
            document.getElementById('editMode').style.display = 'block';
            
            document.getElementById('eName').value = p.name;
            document.getElementById('eBio').value = p.bio;
            tempSkills = p.skills ? p.skills.split(',') : [];
            renderTempSkills();
        }

        function closeEdit() {
            document.getElementById('viewMode').style.display = 'block';
            document.getElementById('editMode').style.display = 'none';
        }

        function addSkillTag(val) {
            if(val && !tempSkills.includes(val)) {
                tempSkills.push(val);
                renderTempSkills();
            }
        }

        function renderTempSkills() {
            const el = document.getElementById('editTags');
            el.innerHTML = tempSkills.map(s => `<span class="skill-tag">${s}</span>`).join('');
        }

        async function saveProfile() {
            const n = document.getElementById('eName').value;
            const b = document.getElementById('eBio').value;
            const s = tempSkills.join(',');
            
            showToast("Menyimpan...");
            await fetch(API_URL, {method:"POST", body:JSON.stringify({
                action:"update_profile", user:user, name:n, bio:b, skills:s
            })});
            
            closeEdit();
            loadData(); // Refresh data
        }

        // --- AUTH & UTILS ---
        async function auth(type) {
            const u = document.getElementById(type=='login'?'lUser':'rUser').value;
            const p = document.getElementById(type=='login'?'lPass':'rPass').value;
            const s = document.getElementById('rSoc').value;
            const sk = document.getElementById('rSkill').value;

            if(!u || !p) return showToast("Data tidak lengkap!");

            const btn = document.querySelector('.full-btn'); btn.innerText = "...";
            const res = await fetch(API_URL, {method:"POST", body:JSON.stringify({
                action:type, user:u, pass:p, soc:s, skills:sk
            })});
            const j = await res.json();

            if(j.status === 'success') {
                localStorage.setItem('ieaUser', u);
                location.reload();
            } else {
                showToast(j.message);
                btn.innerText = type.toUpperCase();
            }
        }

        function nav(t, el) {
            tab = t;
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            if(el) el.classList.add('active');
            render();
        }

        function toggleSearch(forceShow) {
            const el = document.getElementById('searchBox');
            if(forceShow) el.style.display = 'flex';
            else el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
            if(el.style.display === 'flex') document.getElementById('searchInput').focus();
            else { searchQ=""; loadData(); }
        }
        function doSearch() { searchQ = document.getElementById('searchInput').value.toLowerCase(); render(); }
        
        function toggleTools() { document.getElementById('toolsArea').classList.toggle('show'); }
        function myProf() { viewUser(user); }
        function closeModal() { document.getElementById('profModal').style.display = 'none'; }
        function toggleAuth(reg) { document.getElementById('formLogin').style.display = reg?'none':'block'; document.getElementById('formReg').style.display = reg?'block':'none'; }
        function logout() { localStorage.removeItem('ieaUser'); location.reload(); }
        function checkNotif() { if(db.notifs.some(n=>n[5]=='UNREAD')) document.getElementById('dot').style.display='block'; }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
        function timeAgo(d) {
            const s = Math.floor((new Date()-new Date(d))/1000);
            if(s>31536000) return Math.floor(s/31536000)+"thn";
            if(s>86400) return Math.floor(s/86400)+"hr";
            if(s>3600) return Math.floor(s/3600)+"jam";
            return Math.floor(s/60)+"mnt";
        }
    </script>
</body>
</html>
